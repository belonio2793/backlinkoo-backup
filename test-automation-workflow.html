<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Workflow Test - Telegraph Bold Text</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            margin: 20px 0; 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            background: #f9f9f9; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #2196F3;
        }
        .error { 
            background: #ffebee; 
            border-left: 4px solid #f44336; 
        }
        .success { 
            background: #e8f5e8; 
            border-left: 4px solid #4caf50; 
        }
        .warning { 
            background: #fff3e0; 
            border-left: 4px solid #ff9800; 
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            overflow-x: auto; 
            font-size: 12px; 
            border-radius: 4px;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #1976D2; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .progress {
            display: none;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .step {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .step.pending { background: #f5f5f5; color: #666; }
        .step.running { background: #e3f2fd; color: #1976D2; }
        .step.success { background: #e8f5e8; color: #2e7d32; }
        .step.error { background: #ffebee; color: #d32f2f; }
    </style>
</head>
<body>
    <h1>üß™ Automation Workflow Test - Telegraph Bold Text Fix</h1>
    
    <div class="test-section">
        <h2>üìù Test Campaign Form</h2>
        <p>This test simulates the full automation workflow to verify that bold text formatting works correctly.</p>
        
        <div class="form-group">
            <label for="targetUrl">Target URL:</label>
            <input type="url" id="targetUrl" value="https://example.com" placeholder="https://example.com">
        </div>
        
        <div class="form-group">
            <label for="keyword">Keyword:</label>
            <input type="text" id="keyword" value="digital marketing" placeholder="digital marketing">
        </div>
        
        <div class="form-group">
            <label for="anchorText">Anchor Text:</label>
            <input type="text" id="anchorText" value="best digital marketing tools" placeholder="best digital marketing tools">
        </div>
        
        <button class="btn" onclick="testCompleteWorkflow()">üöÄ Test Complete Workflow</button>
        <button class="btn" onclick="testContentGeneration()">üìÑ Test Content Generation Only</button>
        <button class="btn" onclick="testTelegraphPublishing()">üì° Test Telegraph Publishing Only</button>
        <button class="btn" onclick="testWriteAsPublishing()">‚úçÔ∏è Test Write.as Publishing Only</button>
        
        <div id="progress" class="progress">
            <h3>üîÑ Workflow Progress:</h3>
            <div id="step1" class="step pending">1. Generate content with bold formatting</div>
            <div id="step2" class="step pending">2. Publish to Telegraph with proper bold tags</div>
            <div id="step3" class="step pending">3. Verify published content displays bold text correctly</div>
        </div>
        
        <div id="workflow-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä Individual Component Tests</h2>
        
        <button class="btn" onclick="testBoldFormatting()">Test Bold Text Processing</button>
        <button class="btn" onclick="testHTMLToTelegraph()">Test HTML to Telegraph Conversion</button>
        
        <div id="component-results"></div>
    </div>

    <div class="test-section">
        <h2>üîç Telegraph Content Preview</h2>
        <p>This shows how the content will look when converted to Telegraph format:</p>
        
        <div class="form-group">
            <label for="testContent">Test Content (HTML):</label>
            <textarea id="testContent" placeholder="Enter HTML content to test..."><h1>Digital Marketing Guide</h1>

<p>This comprehensive guide covers <strong>essential digital marketing strategies</strong> that every business should know.</p>

<p>Key areas include <strong>SEO optimization</strong>, <strong>content marketing</strong>, and <a href="https://example.com" target="_blank">advanced marketing automation</a>.</p>

<p>‚Ä¢ <strong>Search Engine Optimization:</strong> Improve your website's visibility</p>
<p>‚Ä¢ <strong>Content Strategy:</strong> Create engaging content for your audience</p>
<p>‚Ä¢ <strong>Analytics:</strong> Track and measure your success</p></textarea>
        </div>
        
        <button class="btn" onclick="previewTelegraphContent()">üîç Preview Telegraph Format</button>
        
        <div id="preview-result" class="result" style="display: none;"></div>
    </div>

    <script>
        let isTestRunning = false;

        async function testCompleteWorkflow() {
            if (isTestRunning) return;
            isTestRunning = true;

            const targetUrl = document.getElementById('targetUrl').value;
            const keyword = document.getElementById('keyword').value;
            const anchorText = document.getElementById('anchorText').value;

            if (!targetUrl || !keyword || !anchorText) {
                alert('Please fill in all fields');
                isTestRunning = false;
                return;
            }

            // Show progress
            document.getElementById('progress').style.display = 'block';
            document.getElementById('workflow-result').style.display = 'none';

            const resultDiv = document.getElementById('workflow-result');
            
            try {
                // Step 1: Generate content
                updateStep('step1', 'running', '1. Generating content with bold formatting...');
                
                const contentResponse = await fetch('/.netlify/functions/generate-automation-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, anchorText, targetUrl })
                });

                const contentResult = await contentResponse.json();
                
                if (!contentResult.success) {
                    throw new Error(`Content generation failed: ${contentResult.error}`);
                }

                updateStep('step1', 'success', '1. ‚úÖ Content generated successfully');
                
                const content = contentResult.content[0]; // Get first generated content
                console.log('Generated content:', content);

                // Step 2: Publish to Telegraph
                updateStep('step2', 'running', '2. Publishing to Telegraph with proper formatting...');

                const publishResponse = await fetch('/.netlify/functions/telegraph-publisher', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: `${keyword} - Professional Guide`,
                        content: content.content,
                        author_name: 'Test Author',
                        keyword: keyword
                    })
                });

                const publishResult = await publishResponse.json();
                
                if (!publishResult.success) {
                    throw new Error(`Telegraph publishing failed: ${publishResult.error}`);
                }

                updateStep('step2', 'success', '2. ‚úÖ Published to Telegraph successfully');

                // Step 3: Verify the published content
                updateStep('step3', 'running', '3. Verifying published content...');

                // Wait a moment for Telegraph to process
                await new Promise(resolve => setTimeout(resolve, 2000));

                const verifyResponse = await fetch(publishResult.url, { method: 'HEAD' });
                
                if (!verifyResponse.ok) {
                    throw new Error(`Telegraph URL verification failed: ${verifyResponse.status}`);
                }

                updateStep('step3', 'success', '3. ‚úÖ Telegraph content verified and accessible');

                // Show success result
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>üéâ Workflow Test Completed Successfully!</h3>
                        <p><strong>Published URL:</strong> <a href="${publishResult.url}" target="_blank">${publishResult.url}</a></p>
                        <p><strong>Word Count:</strong> ${content.wordCount} words</p>
                        <p><strong>Content Type:</strong> ${content.type}</p>
                        <details>
                            <summary>View Generated Content</summary>
                            <pre>${content.content}</pre>
                        </details>
                    </div>
                `;
                resultDiv.style.display = 'block';

            } catch (error) {
                console.error('Workflow test failed:', error);
                
                // Update failed step
                const runningStep = document.querySelector('.step.running');
                if (runningStep) {
                    updateStep(runningStep.id, 'error', runningStep.textContent.replace('...', ' - FAILED'));
                }

                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Workflow Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Check the browser console for more details.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            } finally {
                isTestRunning = false;
            }
        }

        async function testContentGeneration() {
            const keyword = document.getElementById('keyword').value;
            const anchorText = document.getElementById('anchorText').value;
            const targetUrl = document.getElementById('targetUrl').value;

            if (!keyword || !anchorText || !targetUrl) {
                alert('Please fill in all fields');
                return;
            }

            const resultDiv = document.getElementById('workflow-result');
            resultDiv.innerHTML = '<div class="result">Generating content...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch('/.netlify/functions/generate-automation-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, anchorText, targetUrl })
                });

                const result = await response.json();

                if (result.success) {
                    const content = result.content[0];
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Content Generated Successfully</h3>
                            <p><strong>Type:</strong> ${content.type}</p>
                            <p><strong>Word Count:</strong> ${content.wordCount}</p>
                            <details>
                                <summary>View Content</summary>
                                <pre>${content.content}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Content Generation Failed</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Request Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testTelegraphPublishing() {
            const testContent = `<h1>Test Article</h1>

<p>This is a test article with <strong>bold text</strong> and <a href="https://example.com">a link</a>.</p>

<p>‚Ä¢ <strong>First point:</strong> This should be bold</p>
<p>‚Ä¢ <strong>Second point:</strong> This should also be bold</p>`;

            const resultDiv = document.getElementById('workflow-result');
            resultDiv.innerHTML = '<div class="result">Publishing to Telegraph...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch('/.netlify/functions/telegraph-publisher', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Telegraph Bold Text Test',
                        content: testContent,
                        author_name: 'Test Author'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Telegraph Publishing Successful</h3>
                            <p><strong>URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></p>
                            <p>Check the published page to verify bold text formatting.</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Telegraph Publishing Failed</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Request Failed</h3>
                        <p>${error.message}</p>
                    `;
                }
            }
        }

        function updateStep(stepId, status, text) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            step.textContent = text;
        }

        function testBoldFormatting() {
            // Simple client-side test for bold formatting
            const testCases = [
                '<strong>Bold with strong</strong>',
                '<b>Bold with b tag</b>',
                'Text with <strong>bold in middle</strong> and more text',
                '<strong>Bold</strong> and <a href="https://example.com">link</a>',
                '‚Ä¢ <strong>List item:</strong> with description'
            ];

            let results = '<h3>Bold Text Processing Tests:</h3>';
            
            testCases.forEach((testCase, index) => {
                const processed = simulateProcessHTMLContent(testCase);
                results += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <strong>Test ${index + 1}:</strong> <code>${testCase}</code><br>
                        <strong>Result:</strong> <pre style="margin: 5px 0;">${JSON.stringify(processed, null, 2)}</pre>
                    </div>
                `;
            });

            document.getElementById('component-results').innerHTML = results;
        }

        function simulateProcessHTMLContent(text) {
            // Simplified version of the server-side function for testing
            const result = [];
            let currentIndex = 0;
            
            const formatRegex = /(<a\s+href="([^"]+)"[^>]*>([^<]+)<\/a>|<strong>([^<]+)<\/strong>|<b>([^<]+)<\/b>)/gi;
            let match;
            
            while ((match = formatRegex.exec(text)) !== null) {
                if (match.index > currentIndex) {
                    const beforeText = text.substring(currentIndex, match.index);
                    if (beforeText.trim()) {
                        result.push(beforeText);
                    }
                }
                
                if (match[0].startsWith('<a')) {
                    result.push({
                        tag: 'a',
                        attrs: { href: match[2] },
                        children: [match[3]]
                    });
                } else if (match[0].startsWith('<strong>') || match[0].startsWith('<b>')) {
                    const content = match[4] || match[5];
                    result.push({
                        tag: 'b',
                        children: [content]
                    });
                }
                
                currentIndex = match.index + match[0].length;
            }
            
            if (currentIndex < text.length) {
                const remainingText = text.substring(currentIndex);
                if (remainingText.trim()) {
                    result.push(remainingText);
                }
            }
            
            return result.length > 0 ? result : [text];
        }

        function previewTelegraphContent() {
            const content = document.getElementById('testContent').value;
            const resultDiv = document.getElementById('preview-result');
            
            // Simulate the Telegraph conversion process
            const telegraphNodes = simulateHTMLToTelegraph(content);
            
            resultDiv.innerHTML = `
                <h3>Telegraph Format Preview:</h3>
                <pre>${JSON.stringify(telegraphNodes, null, 2)}</pre>
                <div style="margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                    <h4>How this will appear on Telegraph:</h4>
                    ${renderTelegraphPreview(telegraphNodes)}
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        function simulateHTMLToTelegraph(html) {
            const lines = html.split('\n');
            const telegraphNodes = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                if (trimmed.startsWith('<h1>')) {
                    telegraphNodes.push({
                        tag: 'h3',
                        children: [trimmed.replace(/<\/?h1>/g, '')]
                    });
                } else if (trimmed.startsWith('<h2>')) {
                    telegraphNodes.push({
                        tag: 'h4',
                        children: [trimmed.replace(/<\/?h2>/g, '')]
                    });
                } else if (trimmed.startsWith('<p>')) {
                    const processedText = simulateProcessHTMLContent(trimmed.replace(/<\/?p>/g, ''));
                    if (processedText.length > 0) {
                        telegraphNodes.push({
                            tag: 'p',
                            children: processedText
                        });
                    }
                }
            }
            
            return telegraphNodes;
        }

        function renderTelegraphPreview(nodes) {
            return nodes.map(node => {
                const tag = node.tag;
                const children = node.children.map(child => {
                    if (typeof child === 'string') {
                        return child;
                    } else if (child.tag === 'b') {
                        return `<strong>${child.children.join('')}</strong>`;
                    } else if (child.tag === 'a') {
                        return `<a href="${child.attrs.href}" target="_blank">${child.children.join('')}</a>`;
                    }
                    return JSON.stringify(child);
                }).join('');
                
                return `<${tag}>${children}</${tag}>`;
            }).join('\n');
        }

        // Initialize test content
        document.getElementById('testContent').value = `<h1>Digital Marketing Success Guide</h1>

<p>Master the art of <strong>digital marketing</strong> with these proven strategies that deliver <strong>measurable results</strong>.</p>

<p>This comprehensive guide covers everything from <strong>SEO fundamentals</strong> to <a href="https://example.com" target="_blank">advanced marketing automation</a> techniques.</p>

<p>‚Ä¢ <strong>Search Engine Optimization:</strong> Boost your organic visibility</p>
<p>‚Ä¢ <strong>Content Marketing:</strong> Create engaging content that converts</p>
<p>‚Ä¢ <strong>Analytics & Tracking:</strong> Measure what matters for growth</p>`;
    </script>
</body>
</html>
