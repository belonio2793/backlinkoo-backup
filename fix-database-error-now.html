<!DOCTYPE html>
<html>
<head>
    <title>Fix Database Permission Error</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .error { background: #ffebee; border: 1px solid #f44336; padding: 15px; border-radius: 5px; }
        .solution { background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; }
        .steps { counter-reset: step-counter; }
        .step { counter-increment: step-counter; margin: 10px 0; }
        .step::before { content: counter(step-counter) ". "; font-weight: bold; color: #1976d2; }
    </style>
</head>
<body>
    <h1>ðŸš¨ Fix Database Permission Error</h1>
    
    <div class="error">
        <h3>Error:</h3>
        <code>"permission denied for table users"</code>
        <p>This is a Row Level Security (RLS) policy issue in Supabase.</p>
    </div>

    <div class="solution">
        <h3>âœ… Quick Fix (2 minutes):</h3>
        
        <div class="steps">
            <div class="step">Open <strong>Supabase Dashboard</strong> â†’ <strong>SQL Editor</strong></div>
            <div class="step">Copy the SQL below and paste it into the editor</div>
            <div class="step">Click <strong>"RUN"</strong></div>
            <div class="step">Refresh your application</div>
        </div>
        
        <h4>SQL to Run:</h4>
        <div class="code">
-- Fix RLS permission error<br>
DROP FUNCTION IF EXISTS public.get_current_user_role() CASCADE;<br>
ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;<br>
ALTER TABLE public.campaign_runtime_metrics DISABLE ROW LEVEL SECURITY;<br>
<br>
-- Drop all problematic policies<br>
DO $$<br>
DECLARE pol record;<br>
BEGIN<br>
&nbsp;&nbsp;&nbsp;&nbsp;FOR pol IN SELECT policyname FROM pg_policies WHERE tablename IN ('profiles', 'campaign_runtime_metrics')<br>
&nbsp;&nbsp;&nbsp;&nbsp;LOOP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I', pol.policyname, 'profiles');<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I', pol.policyname, 'campaign_runtime_metrics');<br>
&nbsp;&nbsp;&nbsp;&nbsp;END LOOP;<br>
END $$;<br>
<br>
-- Re-enable RLS with safe policies<br>
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;<br>
ALTER TABLE public.campaign_runtime_metrics ENABLE ROW LEVEL SECURITY;<br>
<br>
-- Create simple policies<br>
CREATE POLICY "profiles_own" ON public.profiles FOR ALL USING (auth.uid() = user_id);<br>
CREATE POLICY "metrics_own" ON public.campaign_runtime_metrics FOR ALL USING (auth.uid() = user_id);<br>
<br>
SELECT 'Fixed! Refresh your app now.' as status;
        </div>
    </div>

    <div style="background: #fff3e0; border: 1px solid #ff9800; padding: 15px; border-radius: 5px;">
        <h3>ðŸ’¡ What This Does:</h3>
        <ul>
            <li>Removes the problematic function causing recursion</li>
            <li>Resets all RLS policies safely</li>
            <li>Creates simple, working policies</li>
            <li>Fixes the "permission denied" error permanently</li>
        </ul>
    </div>

    <script>
        // Auto-copy SQL when page loads
        window.onload = function() {
            const sql = `-- Fix RLS permission error
DROP FUNCTION IF EXISTS public.get_current_user_role() CASCADE;
ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.campaign_runtime_metrics DISABLE ROW LEVEL SECURITY;

-- Drop all problematic policies  
DO $$
DECLARE pol record;
BEGIN
    FOR pol IN SELECT policyname FROM pg_policies WHERE tablename IN ('profiles', 'campaign_runtime_metrics')
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I', pol.policyname, 'profiles');
        EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I', pol.policyname, 'campaign_runtime_metrics');
    END LOOP;
END $$;

-- Re-enable RLS with safe policies
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.campaign_runtime_metrics ENABLE ROW LEVEL SECURITY;

-- Create simple policies
CREATE POLICY "profiles_own" ON public.profiles FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "metrics_own" ON public.campaign_runtime_metrics FOR ALL USING (auth.uid() = user_id);

SELECT 'Fixed! Refresh your app now.' as status;`;
            
            console.log('ðŸ”§ SQL Fix Ready - Copy from console:');
            console.log(sql);
        };
    </script>
</body>
</html>
