<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Endpoint Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        pre { background: #333; color: #fff; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .status { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .status.ok { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>üí≥ Payment Endpoint Test</h1>
    <p>This page tests the fixed payment endpoint functionality.</p>

    <div class="test-section">
        <h3>üîç Test Status</h3>
        <p>Endpoint: <code>/.netlify/functions/create-payment</code></p>
        <p>Status: <span id="endpoint-status" class="status">Testing...</span></p>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h3>üß™ Test Payment Request</h3>
        <p>Click to test the payment endpoint with the correct data structure:</p>
        <button onclick="testPaymentEndpoint()">Test Credit Purchase (50 Credits)</button>
        <button onclick="testPaymentEndpoint(100)">Test Credit Purchase (100 Credits)</button>
        <button onclick="testInvalidRequest()">Test Invalid Request</button>
    </div>

    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="results"></div>
    </div>

    <script>
        async function testPaymentEndpoint(credits = 50) {
            const resultsDiv = document.getElementById('results');
            const amount = credits === 50 ? 15 : credits === 100 ? 25 : 50;
            
            resultsDiv.innerHTML += `<div class="test-section"><h4>üß™ Testing ${credits} Credits Purchase ($${amount})</h4><p>Sending request...</p></div>`;

            try {
                const response = await fetch('/.netlify/functions/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        credits: credits,
                        paymentMethod: 'stripe',
                        productName: `${credits} Backlink Credits`,
                        isGuest: true,
                        guestEmail: 'test@example.com'
                    })
                });

                const status = response.ok ? 'success' : 'error';
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw: responseText };
                }

                resultsDiv.innerHTML += `
                    <div class="test-section ${status}">
                        <h4>‚úÖ Response for ${credits} Credits</h4>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Success:</strong> ${response.ok ? 'Yes' : 'No'}</p>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre>
                    </div>
                `;

                if (response.ok && responseData.url) {
                    resultsDiv.innerHTML += `
                        <div class="test-section success">
                            <h4>üéâ Payment URL Generated!</h4>
                            <p>Stripe checkout URL created successfully. The payment flow should now work.</p>
                            <p><strong>Note:</strong> This is a test - don't click the actual checkout URL unless you want to make a real purchase!</p>
                        </div>
                    `;
                }

                // Update overall status
                document.getElementById('endpoint-status').className = 'status ok';
                document.getElementById('endpoint-status').textContent = 'Working ‚úÖ';

            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-section error">
                        <h4>‚ùå Error Testing ${credits} Credits</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack || 'No stack trace available'}</pre>
                    </div>
                `;

                document.getElementById('endpoint-status').className = 'status error';
                document.getElementById('endpoint-status').textContent = 'Error ‚ùå';
            }
        }

        async function testInvalidRequest() {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML += `<div class="test-section"><h4>üß™ Testing Invalid Request (Missing paymentMethod)</h4><p>Sending request...</p></div>`;

            try {
                const response = await fetch('/.netlify/functions/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: 15,
                        credits: 50,
                        // Missing paymentMethod and productName intentionally
                        isGuest: true,
                        guestEmail: 'test@example.com'
                    })
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw: responseText };
                }

                const expectedError = !response.ok && responseData.error && responseData.error.includes('stripe');

                resultsDiv.innerHTML += `
                    <div class="test-section ${expectedError ? 'success' : 'error'}">
                        <h4>${expectedError ? '‚úÖ' : '‚ùå'} Invalid Request Test</h4>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Expected:</strong> Error about payment method</p>
                        <p><strong>Actual:</strong> ${expectedError ? 'Got expected error ‚úÖ' : 'Unexpected result ‚ùå'}</p>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-section warning">
                        <h4>‚ö†Ô∏è Network Error Testing Invalid Request</h4>
                        <p>This could indicate the endpoint is not accessible at all.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testPaymentEndpoint(50);
            }, 1000);
        });
    </script>
</body>
</html>
