<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Test Automation Functionality</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-button { padding: 12px 24px; margin: 8px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; }
        .test-button.primary { background: #007bff; color: white; }
        .test-button.success { background: #28a745; color: white; }
        .test-button.warning { background: #ffc107; color: black; }
        .test-button.danger { background: #dc3545; color: white; }
        .result { margin: 10px 0; padding: 12px; border-radius: 5px; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .loading { opacity: 0.6; }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Automation Functionality Test</h1>
        <div class="status" id="connection-status">ğŸ” Testing connection...</div>
        
        <div class="test-section">
            <h2>ğŸ—„ï¸ Database Schema Tests</h2>
            <button class="test-button primary" onclick="testDatabaseSchema()">Test Database Tables</button>
            <button class="test-button primary" onclick="testEmergencySchemaFix()">Test Schema Fix Function</button>
            <div id="schema-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸš€ Campaign Processor Tests</h2>
            <button class="test-button success" onclick="testCampaignProcessor()">Test Campaign Processor</button>
            <button class="test-button success" onclick="testHealthCheck()">Test Function Health</button>
            <div id="processor-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”„ Campaign Resume Test</h2>
            <button class="test-button warning" onclick="testCampaignResume()">Test Campaign Resume Flow</button>
            <div id="resume-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Results Summary</h2>
            <div id="test-summary">
                <p>Run tests above to see results summary.</p>
            </div>
        </div>
    </div>

    <script>
        let testResults = [];

        function updateConnectionStatus(online) {
            const status = document.getElementById('connection-status');
            if (online) {
                status.className = 'status online';
                status.textContent = 'âœ… Connected to automation service';
            } else {
                status.className = 'status offline';
                status.textContent = 'âŒ Connection failed';
            }
        }

        function addResult(containerId, message, type = 'info', details = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            
            let content = message;
            if (details) {
                content += `<br><pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            div.innerHTML = content;
            container.appendChild(div);
            
            // Track results for summary
            testResults.push({ test: containerId, type, message });
            updateSummary();
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testDatabaseSchema() {
            clearResults('schema-results');
            addResult('schema-results', 'ğŸ” Testing database schema...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/emergency-schema-fix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });

                if (response.ok) {
                    const result = await response.json();
                    addResult('schema-results', 'âœ… Database schema test passed', 'success', result);
                    updateConnectionStatus(true);
                } else {
                    const error = await response.text();
                    addResult('schema-results', 'âŒ Database schema test failed', 'error', { status: response.status, error });
                }
            } catch (error) {
                addResult('schema-results', 'âŒ Network error testing schema', 'error', { error: error.message });
                updateConnectionStatus(false);
            }
        }

        async function testEmergencySchemaFix() {
            addResult('schema-results', 'ğŸ”§ Running emergency schema fix...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/emergency-schema-fix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const result = await response.json();
                    addResult('schema-results', 'âœ… Emergency schema fix completed', 'success', result);
                } else {
                    const error = await response.text();
                    addResult('schema-results', 'âŒ Emergency schema fix failed', 'error', { status: response.status, error });
                }
            } catch (error) {
                addResult('schema-results', 'âŒ Network error running schema fix', 'error', { error: error.message });
            }
        }

        async function testCampaignProcessor() {
            clearResults('processor-results');
            addResult('processor-results', 'ğŸš€ Testing campaign processor...', 'info');
            
            const testData = {
                keyword: 'automation test',
                anchorText: 'test automation',
                targetUrl: 'https://example.com',
                campaignId: 'test-' + Date.now()
            };

            try {
                const response = await fetch('/.netlify/functions/working-campaign-processor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        addResult('processor-results', 'âœ… Campaign processor working correctly', 'success', result);
                    } else {
                        addResult('processor-results', 'âš ï¸ Campaign processor returned error', 'error', result);
                    }
                } else {
                    const error = await response.text();
                    addResult('processor-results', 'âŒ Campaign processor HTTP error', 'error', { status: response.status, error });
                }
            } catch (error) {
                addResult('processor-results', 'âŒ Network error testing processor', 'error', { error: error.message });
            }
        }

        async function testHealthCheck() {
            addResult('processor-results', 'ğŸ’š Testing function health...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/function-health-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const result = await response.json();
                    addResult('processor-results', 'âœ… Function health check passed', 'success', result);
                } else {
                    const error = await response.text();
                    addResult('processor-results', 'âŒ Function health check failed', 'error', { status: response.status, error });
                }
            } catch (error) {
                addResult('processor-results', 'âŒ Network error in health check', 'error', { error: error.message });
            }
        }

        async function testCampaignResume() {
            clearResults('resume-results');
            addResult('resume-results', 'ğŸ”„ Testing campaign resume functionality...', 'info');
            
            // This would typically test the actual resume flow
            // For now, we'll test if the automation service responds correctly
            try {
                // Test 1: Check if automation service is accessible
                const response = await fetch('/automation');
                if (response.ok) {
                    addResult('resume-results', 'âœ… Automation page accessible', 'success');
                } else {
                    addResult('resume-results', 'âŒ Automation page not accessible', 'error');
                }

                // Test 2: Check if the campaign processor can handle resume scenarios
                const resumeTestData = {
                    keyword: 'resume test',
                    anchorText: 'resume link',
                    targetUrl: 'https://resumetest.com',
                    campaignId: 'resume-test-' + Date.now()
                };

                const processorResponse = await fetch('/.netlify/functions/working-campaign-processor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resumeTestData)
                });

                if (processorResponse.ok) {
                    const result = await processorResponse.json();
                    addResult('resume-results', 'âœ… Campaign resume flow test passed', 'success', {
                        success: result.success,
                        promptUsed: result.data?.promptUsed,
                        publishedUrls: result.data?.publishedUrls
                    });
                } else {
                    const error = await processorResponse.text();
                    addResult('resume-results', 'âŒ Campaign resume flow test failed', 'error', error);
                }

            } catch (error) {
                addResult('resume-results', 'âŒ Network error testing resume', 'error', { error: error.message });
            }
        }

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const totalTests = testResults.length;

            let content = `<h3>ğŸ“Š Test Summary</h3>`;
            content += `<p><strong>Total Tests:</strong> ${totalTests}</p>`;
            content += `<p><strong>âœ… Passed:</strong> ${successCount}</p>`;
            content += `<p><strong>âŒ Failed:</strong> ${errorCount}</p>`;
            
            if (errorCount === 0 && successCount > 0) {
                content += `<div class="result success">ğŸ‰ All tests passing! Automation functionality is working correctly.</div>`;
            } else if (errorCount > 0) {
                content += `<div class="result error">âš ï¸ Some tests failed. Check individual test results above.</div>`;
            }

            summary.innerHTML = content;
        }

        // Auto-run basic connectivity test on load
        document.addEventListener('DOMContentLoaded', function() {
            testDatabaseSchema();
        });
    </script>
</body>
</html>
