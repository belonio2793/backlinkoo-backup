<!DOCTYPE html>
<html>
<head>
    <title>Create Affiliate Table</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Creating affiliate_programs table...</h1>
    <div id="status">Initializing...</div>
    
    <script>
        const supabaseUrl = 'https://bclhqtjxaaxdvlnubhhd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGhxdGp4YWF4ZHZsbnViaGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5MDU1OTUsImV4cCI6MjA0ODQ4MTU5NX0.v2BI2WiXVnobWh76v6_RW3PUqcdZSNJCjEiw6gOjKJQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function createTable() {
            const statusEl = document.getElementById('status');
            
            try {
                statusEl.innerHTML = 'Testing if table exists...';
                
                // Test if table exists
                const { data, error } = await supabase
                    .from('affiliate_programs')
                    .select('id')
                    .limit(1);
                
                if (!error) {
                    statusEl.innerHTML = '<span style="color: green;">✅ Table already exists!</span>';
                    return;
                }
                
                if (!error.message.includes('does not exist')) {
                    statusEl.innerHTML = `<span style="color: red;">❌ Unexpected error: ${error.message}</span>`;
                    return;
                }
                
                statusEl.innerHTML = 'Table does not exist. Creating via Netlify function...';
                
                // Call our Netlify function to create the table
                const response = await fetch('/api/create-affiliate-tables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusEl.innerHTML = '<span style="color: green;">✅ Table created successfully!</span>';
                    
                    // Test the table
                    setTimeout(async () => {
                        const { data: testData, error: testError } = await supabase
                            .from('affiliate_programs')
                            .select('id')
                            .limit(1);
                        
                        if (testError) {
                            statusEl.innerHTML += `<br><span style="color: red;">❌ Verification failed: ${testError.message}</span>`;
                        } else {
                            statusEl.innerHTML += '<br><span style="color: green;">✅ Table verified and ready!</span>';
                        }
                    }, 1000);
                } else {
                    statusEl.innerHTML = `<span style="color: red;">❌ Failed to create table: ${result.error}</span>`;
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span style="color: red;">❌ Error: ${error.message}</span>`;
            }
        }
        
        // Run on page load
        createTable();
    </script>
</body>
</html>
